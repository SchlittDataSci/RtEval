---
title: "Collabathon: Checking R(t)"
author: Chad Milando, PhD*^[Boston University, Environmental Health, cmilando@bu.edu]; Laura White, PhD^[Boston University, Biostatistics]; 
date: "2024-09-24"
output: html_document
runtime: shiny
---

```{=html}
<style type="text/css">
.main-container {
  max-width: 750px;
  margin-left: auto;
  margin-right: auto;
}
</style>
```

```{css, echo=FALSE}
.plotlysize {
  height: 220px;
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plotly)
library(purrr)
library(shiny)
library(splines)
library(tidyverse)
```

### EpiEstim

Using the serial interval, check using EpiEstim

```{r EpiEstim, echo = F}
all_data <- readRDS("all_data.RDS")

inputPanel(
  sliderInput("epimax_day", label = "Max day:",
              min = 5, max = 100, 
              value = 64, step = 1)
)

epiestim_dat <- reactive({
  
  require(EpiEstim)
  
  # get incidence
  incidence_df <- data.frame(
    dates = all_data$cases$day,
    I = as.vector(all_data$cases$daily_reports)
  )
  colnames(incidence_df) <- c('dates', 'I')
  
  # 
  incidence_df <- incidence_df %>% filter(dates <= input$epimax_day)
  
  head(incidence_df)
  tail(incidence_df)
  dim(incidence_df)
  
  # Serial interval from data PMF
  si_distr <- as.matrix(all_data$serial$Px)
  if (all_data$serial$Day[1] == 1) si_distr <- c(0, si_distr)
  si_distr
  
  # Estimate R DAILY
  getR <- EpiEstim::estimate_R(
    incid = incidence_df,
    method = "non_parametric_si",
    config = make_config(list(
      si_distr = si_distr,
      t_start = 2:nrow(incidence_df),
      t_end = 2:nrow(incidence_df)
    )),
    backimputation_window = 10
  )
  
  #
  INCUBATION_SHIFT = round(weighted.mean(x = all_data$incubation$Day,
                                         w = all_data$incubation$Px))
  
  REPORTINGDELAY_SHIFT = round(weighted.mean(x = all_data$reporting_delay$Day,
                                             w = all_data$reporting_delay$Px))
  
  # PLOT DATA
  plot_data <- data.frame( ## ANNE
    package = "EpiEstim",
    date = all_data$cases$day[getR$R$t_end] - INCUBATION_SHIFT - REPORTINGDELAY_SHIFT,
    Rt_median = getR$R$`Median(R)`,
    Rt_lb = getR$R$`Quantile.0.025(R)`,
    Rt_ub = getR$R$`Quantile.0.975(R)`
  )
  
  plot_data
  
})

pp <- reactive({
  
  require(patchwork)
  
  # p1 <- as_tibble(all_data$cases) %>%
  #   rename(y = input$case_choice) %>%
  #   ggplot() +
  #   geom_line(aes(x = day, y = y)) +
  #   xlab('Days') + ylab(input$case_choice) +
  #   coord_cartesian(xlim = c(0, input$epimax_day)) +
  #   theme(
  #     axis.text = element_text(size = 10),
  #         axis.title = element_text(size = 14)
  #   )
  
as_tibble(epiestim_dat()) %>%
  ggplot() +
  geom_hline(yintercept = 1, linetype = "11") +
  # *******
  # this is the true r(t), back-calculated
  geom_line(aes(x = Day, y = Rt_calc), data = all_data$rt) +
  # *******
  geom_ribbon(aes(x = date, ymin = Rt_lb, ymax = Rt_ub, fill = package),
              alpha = 0.25) +
  geom_line(aes(x = date, y = Rt_median, color = package)) +
  coord_cartesian(ylim = c(0, 5)) +
  xlab("Days") +
  ylab("Rt") +
  theme(
    axis.text = element_text(size = 10),
    axis.title = element_text(size = 14)
  )
  
   # p1 + p2 + plot_layout(ncol = 1)
  
})


renderPlot({ pp() }, height = 400)



```
